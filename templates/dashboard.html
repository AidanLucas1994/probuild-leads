{% extends "base.html" %}

{% block content %}
<div class="dashboard">
    <nav class="dashboard-nav">
        <div class="nav-content">
            <div class="nav-title-group">
                <div class="nav-title">ProBuild Leads.AI</div>
                <div class="nav-subtitle">Smarter Leads for Smarter Builders</div>
            </div>
            <a href="{{ url_for('index') }}" class="nav-link">Find More Leads</a>
        </div>
    </nav>

    <main class="dashboard-content">
        <div class="page-header">
            <h1>Leads Dashboard</h1>
            <p class="header-description">View and filter construction project leads</p>
        </div>

        <!-- Filter Controls -->
        <div class="filter-section">
            <h3>Filter Leads</h3>
            <div class="filter-controls">
                <div class="filter-group">
                    <label for="contractorType">Contractor Type</label>
                    <select id="contractorType" class="filter-select" multiple>
                        <option value="" disabled>Select Contractor Types...</option>
                        <!-- Options will be populated dynamically -->
                    </select>
                    <div class="selected-options" id="contractorType-selected"></div>
                </div>
                <div class="filter-group">
                    <label for="status">Status</label>
                    <select id="status" class="filter-select" multiple>
                        <option value="" disabled>Select Statuses...</option>
                        <!-- Options will be populated dynamically -->
                    </select>
                    <div class="selected-options" id="status-selected"></div>
                </div>
                <div class="filter-group">
                    <label for="workType">Work Type</label>
                    <select id="workType" class="filter-select" multiple>
                        <option value="" disabled>Select Work Types...</option>
                        <!-- Options will be populated dynamically -->
                    </select>
                    <div class="selected-options" id="workType-selected"></div>
                </div>
                <div class="filter-group value-range">
                    <label>Construction Value Range</label>
                    <div class="range-inputs">
                        <div class="value-input-wrapper">
                            <span class="currency-symbol">$</span>
                            <input type="number" id="minValue" placeholder="Min Value" class="value-input">
                        </div>
                        <span class="range-separator">to</span>
                        <div class="value-input-wrapper">
                            <span class="currency-symbol">$</span>
                            <input type="number" id="maxValue" placeholder="Max Value" class="value-input">
                        </div>
                    </div>
                </div>
                <div class="filter-actions">
                    <button id="resetFilters" class="reset-btn">
                        <span class="btn-icon">×</span>
                        Clear All Filters
                    </button>
                    <button id="applyFilters" class="apply-btn">
                        Apply Filters
                    </button>
                </div>
            </div>
            <div id="active-filters" class="active-filters"></div>
        </div>

        <div class="dashboard-header">
            <h2>Contractor Summary</h2>
            <div class="stats-grid" id="contractor-stats">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>

        <div class="contractor-sections" id="contractor-sections">
            <!-- Will be populated by JavaScript -->
        </div>

        <!-- Add pagination controls -->
        <div class="pagination-controls">
            <div class="pagination-info">
                <span id="pagination-summary"></span>
            </div>
            <div class="pagination-buttons">
                <button id="prevPage" class="pagination-btn" disabled>Previous</button>
                <span id="currentPage"></span>
                <button id="nextPage" class="pagination-btn" disabled>Next</button>
            </div>
        </div>
    </main>
</div>

<!-- Modal for lead details -->
<div id="leadModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <div id="leadDetails"></div>
    </div>
</div>

<style>
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.stat-card h3 {
    margin: 0;
    color: #666;
    font-size: 0.9rem;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    margin-top: 0.5rem;
    color: #2c3e50;
}

.contractor-section {
    margin-bottom: 2rem;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    overflow: hidden;
}

.section-header {
    background: #f8f9fa;
    padding: 1rem;
    border-bottom: 1px solid #e9ecef;
}

.section-header h3 {
    margin: 0;
    color: #2c3e50;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.section-header .count {
    font-size: 0.9rem;
    color: #6c757d;
}

.permit-table {
    width: 100%;
    border-collapse: collapse;
}

.permit-table th,
.permit-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid #e9ecef;
}

.permit-table th {
    background: #f8f9fa;
    font-weight: 600;
    color: #495057;
}

.permit-table tr:hover {
    background: #f8f9fa;
}

.status-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.85rem;
}

.status-approved { background: #d4edda; color: #155724; }
.status-pending { background: #fff3cd; color: #856404; }
.status-in-review { background: #cce5ff; color: #004085; }
.status-expired { background: #f8d7da; color: #721c24; }

.value-cell {
    font-family: monospace;
    text-align: right;
}

.loading {
    text-align: center;
    padding: 2rem;
    color: #6c757d;
}

/* Enhanced Filter Styles */
.filter-section {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.filter-section h3 {
    margin: 0 0 1rem 0;
    color: #2c3e50;
    font-size: 1.2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.filter-controls {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    align-items: start;
    margin-bottom: 1rem;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.filter-group label {
    font-size: 0.9rem;
    color: #495057;
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.filter-select {
    padding: 0.75rem;
    border: 1px solid #ced4da;
    border-radius: 6px;
    font-size: 0.95rem;
    color: #495057;
    background-color: white;
    min-height: 42px;
    max-height: 200px;
    overflow-y: auto;
    cursor: pointer;
    transition: all 0.2s ease;
}

.filter-select:focus {
    border-color: #80bdff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    outline: none;
}

.filter-select option {
    padding: 0.75rem;
    margin: 2px 0;
    border-radius: 4px;
    cursor: pointer;
}

.filter-select option:checked {
    background-color: #007bff;
    color: white;
}

.filter-select option:hover {
    background-color: #f8f9fa;
}

.selected-options {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    min-height: 24px;
    margin-top: 0.25rem;
}

.selected-option {
    background: #e9ecef;
    padding: 0.25rem 0.75rem;
    border-radius: 16px;
    font-size: 0.85rem;
    color: #495057;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.selected-option .remove {
    cursor: pointer;
    color: #6c757d;
    font-weight: bold;
}

.selected-option .remove:hover {
    color: #dc3545;
}

.value-range .range-inputs {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.value-input-wrapper {
    position: relative;
    flex: 1;
}

.currency-symbol {
    position: absolute;
    left: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    color: #6c757d;
    font-weight: 500;
}

.value-input {
    width: 100%;
    padding: 0.75rem;
    padding-left: 1.75rem;
    border: 1px solid #ced4da;
    border-radius: 6px;
    font-size: 0.95rem;
    color: #495057;
    transition: all 0.2s ease;
}

.value-input:focus {
    border-color: #80bdff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    outline: none;
}

.range-separator {
    color: #6c757d;
    font-weight: 500;
}

.filter-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
}

.reset-btn, .apply-btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 6px;
    font-size: 0.95rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.reset-btn {
    background-color: #f8f9fa;
    color: #6c757d;
}

.reset-btn:hover {
    background-color: #e9ecef;
    color: #495057;
}

.apply-btn {
    background-color: #007bff;
    color: white;
}

.apply-btn:hover {
    background-color: #0056b3;
}

.btn-icon {
    font-size: 1.2rem;
    line-height: 1;
}

.active-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 1rem;
    min-height: 24px;
}

.active-filter {
    background: #e7f5ff;
    padding: 0.25rem 0.75rem;
    border-radius: 16px;
    font-size: 0.85rem;
    color: #1864ab;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.active-filter .remove {
    cursor: pointer;
    color: #1864ab;
    font-weight: bold;
}

.active-filter .remove:hover {
    color: #dc3545;
}

/* Add pagination styles */
.pagination-controls {
    background: white;
    padding: 1rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-top: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.pagination-info {
    color: #6c757d;
    font-size: 0.9rem;
}

.pagination-buttons {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.pagination-btn {
    padding: 0.5rem 1rem;
    background-color: #007bff;
    border: none;
    border-radius: 4px;
    color: white;
    cursor: pointer;
    font-size: 0.95rem;
    transition: background-color 0.2s;
}

.pagination-btn:hover:not(:disabled) {
    background-color: #0056b3;
}

.pagination-btn:disabled {
    background-color: #e9ecef;
    cursor: not-allowed;
    color: #6c757d;
}

#currentPage {
    font-weight: 500;
    color: #495057;
}
</style>

<script>
let currentPage = 1;
const itemsPerPage = 50;
let currentFilters = {
    contractorType: [],
    status: [],
    workType: [],
    minValue: null,
    maxValue: null
};

document.addEventListener('DOMContentLoaded', function() {
    // Initialize filter event listeners
    initializeFilters();
    
    // Initial data load
    fetchLeadsData();
});

function initializeFilters() {
    // Add event listeners for filter changes
    ['contractorType', 'status', 'workType'].forEach(filterId => {
        const select = document.getElementById(filterId);
        select.addEventListener('change', function() {
            updateSelectedOptions(filterId);
        });
    });

    // Add event listeners for value inputs
    document.getElementById('minValue').addEventListener('input', debounce(handleValueChange, 500));
    document.getElementById('maxValue').addEventListener('input', debounce(handleValueChange, 500));

    // Add event listeners for buttons
    document.getElementById('resetFilters').addEventListener('click', resetFilters);
    document.getElementById('applyFilters').addEventListener('click', applyFilters);
    document.getElementById('prevPage').addEventListener('click', () => changePage(-1));
    document.getElementById('nextPage').addEventListener('click', () => changePage(1));

    // Initialize selected options display
    ['contractorType', 'status', 'workType'].forEach(updateSelectedOptions);
}

function updateSelectedOptions(filterId) {
    const select = document.getElementById(filterId);
    const selectedContainer = document.getElementById(`${filterId}-selected`);
    selectedContainer.innerHTML = '';

    Array.from(select.selectedOptions).forEach(option => {
        if (option.value && option.value !== '') {
            const tag = document.createElement('span');
            tag.className = 'selected-option';
            tag.innerHTML = `
                ${option.text}
                <span class="remove" data-value="${option.value}">×</span>
            `;
            tag.querySelector('.remove').addEventListener('click', () => {
                option.selected = false;
                updateSelectedOptions(filterId);
                updateCurrentFilters();
            });
            selectedContainer.appendChild(tag);
        }
    });

    updateCurrentFilters();
    updateActiveFilters();
}

function updateCurrentFilters() {
    ['contractorType', 'status', 'workType'].forEach(filterId => {
        const select = document.getElementById(filterId);
        currentFilters[filterId] = Array.from(select.selectedOptions)
            .map(option => option.value)
            .filter(value => value !== '' && value !== 'all');
    });

    currentFilters.minValue = document.getElementById('minValue').value || null;
    currentFilters.maxValue = document.getElementById('maxValue').value || null;
}

function updateActiveFilters() {
    const container = document.getElementById('active-filters');
    container.innerHTML = '';

    let hasActiveFilters = false;

    // Add filter tags for each category
    ['contractorType', 'status', 'workType'].forEach(filterId => {
        const select = document.getElementById(filterId);
        Array.from(select.selectedOptions)
            .filter(option => option.value && option.value !== '')
            .forEach(option => {
                hasActiveFilters = true;
                addActiveFilterTag(container, filterId, option.value, option.text);
            });
    });

    // Add value range filters if set
    const minValue = document.getElementById('minValue').value;
    const maxValue = document.getElementById('maxValue').value;
    if (minValue) {
        hasActiveFilters = true;
        addActiveFilterTag(container, 'minValue', minValue, `Min: $${Number(minValue).toLocaleString()}`);
    }
    if (maxValue) {
        hasActiveFilters = true;
        addActiveFilterTag(container, 'maxValue', maxValue, `Max: $${Number(maxValue).toLocaleString()}`);
    }

    // Update reset button visibility
    document.getElementById('resetFilters').style.display = hasActiveFilters ? 'flex' : 'none';
}

function addActiveFilterTag(container, type, value, text) {
    const tag = document.createElement('span');
    tag.className = 'active-filter';
    tag.innerHTML = `
        ${text}
        <span class="remove" data-type="${type}" data-value="${value}">×</span>
    `;
    tag.querySelector('.remove').addEventListener('click', () => removeFilter(type, value));
    container.appendChild(tag);
}

function removeFilter(type, value) {
    if (type === 'minValue' || type === 'maxValue') {
        document.getElementById(type).value = '';
    } else {
        const select = document.getElementById(type);
        const option = Array.from(select.options).find(opt => opt.value === value);
        if (option) option.selected = false;
        updateSelectedOptions(type);
    }
    updateCurrentFilters();
    applyFilters();
}

function handleValueChange() {
    updateCurrentFilters();
    updateActiveFilters();
}

function applyFilters() {
    currentPage = 1;
    fetchLeadsData();
}

function resetFilters() {
    ['contractorType', 'status', 'workType'].forEach(filterId => {
        const select = document.getElementById(filterId);
        select.selectedIndex = -1;
        updateSelectedOptions(filterId);
    });

    document.getElementById('minValue').value = '';
    document.getElementById('maxValue').value = '';

    currentFilters = {
        contractorType: [],
        status: [],
        workType: [],
        minValue: null,
        maxValue: null
    };

    updateActiveFilters();
    currentPage = 1;
    fetchLeadsData();
}

// Utility function for debouncing
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function fetchLeadsData() {
    const queryParams = new URLSearchParams();
    queryParams.append('page', currentPage);
    queryParams.append('limit', itemsPerPage);
    
    // Add multi-select filter values
    if (currentFilters.contractorType.length > 0) {
        currentFilters.contractorType.forEach(type => {
            queryParams.append('contractor_type[]', type);
        });
    }
    
    if (currentFilters.status.length > 0) {
        currentFilters.status.forEach(status => {
            queryParams.append('status[]', status);
        });
    }
    
    if (currentFilters.workType.length > 0) {
        currentFilters.workType.forEach(type => {
            queryParams.append('work_type[]', type);
        });
    }
    
    if (currentFilters.minValue) queryParams.append('min_value', currentFilters.minValue);
    if (currentFilters.maxValue) queryParams.append('max_value', currentFilters.maxValue);

    // Show loading state
    showLoading();

    fetch(`/leads?${queryParams.toString()}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                updateUI(data);
            } else {
                showError(data.message || 'An error occurred while fetching data');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Failed to fetch leads data');
        })
        .finally(() => {
            hideLoading();
        });
}

function showLoading() {
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'loading';
    loadingDiv.className = 'loading';
    loadingDiv.textContent = 'Loading...';
    document.querySelector('.dashboard-content').appendChild(loadingDiv);
}

function hideLoading() {
    const loadingDiv = document.getElementById('loading');
    if (loadingDiv) {
        loadingDiv.remove();
    }
}

function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    errorDiv.textContent = message;
    document.querySelector('.dashboard-content').appendChild(errorDiv);
    setTimeout(() => errorDiv.remove(), 5000);
}

function updateUI(data) {
    updateContractorStats(data.summary);
    updateContractorSections(data.categorized_permits);
    updatePagination(data.pagination);
    updateValueRangePlaceholders(data);
}

function updatePagination(pagination) {
    document.getElementById('prevPage').disabled = !pagination.has_prev;
    document.getElementById('nextPage').disabled = !pagination.has_next;
    document.getElementById('currentPage').textContent = 
        `Page ${pagination.page} of ${pagination.total_pages}`;
    document.getElementById('pagination-summary').textContent = 
        `Showing ${pagination.start_index} to ${pagination.end_index} of ${pagination.total_records} permits`;
}

function changePage(delta) {
    currentPage += delta;
    fetchLeadsData();
}

function updateValueRangePlaceholders(data) {
    const values = Object.values(data.summary.total_value_by_contractor)
        .map(value => parseFloat(value.replace(/[^0-9.-]+/g, '')));
    const minValue = Math.min(...values);
    const maxValue = Math.max(...values);
    
    document.getElementById('minValue').placeholder = `Min (${formatCurrency(minValue)})`;
    document.getElementById('maxValue').placeholder = `Max (${formatCurrency(maxValue)})`;
}

function calculateSummary(filteredPermits) {
    const summary = {
        total_permits: 0,
        contractor_distribution: {},
        total_value_by_contractor: {}
    };
    
    Object.entries(filteredPermits).forEach(([type, permits]) => {
        summary.total_permits += permits.length;
        summary.contractor_distribution[type] = permits.length;
        
        const totalValue = permits.reduce((sum, permit) => {
            return sum + parseFloat(permit['Construction Value'].replace(/[^0-9.-]+/g, ''));
        }, 0);
        
        summary.total_value_by_contractor[type] = formatCurrency(totalValue);
    });
    
    return summary;
}

function formatCurrency(value) {
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(value);
}

function updateContractorStats(summary) {
    const statsContainer = document.getElementById('contractor-stats');
    statsContainer.innerHTML = '';
    
    const totalCard = createStatCard('Total Permits', summary.total_permits);
    statsContainer.appendChild(totalCard);
    
    Object.entries(summary.contractor_distribution).forEach(([type, count]) => {
        const value = summary.total_value_by_contractor[type];
        const card = createStatCard(type, `${count} permits<br>${value}`);
        statsContainer.appendChild(card);
    });
}

function createStatCard(title, value) {
    const card = document.createElement('div');
    card.className = 'stat-card';
    card.innerHTML = `
        <h3>${title}</h3>
        <div class="stat-value">${value}</div>
    `;
    return card;
}

function updateContractorSections(categorizedPermits) {
    const sectionsContainer = document.getElementById('contractor-sections');
    sectionsContainer.innerHTML = '';
    
    Object.entries(categorizedPermits).forEach(([contractorType, permits]) => {
        if (permits.length > 0) {
            const section = createContractorSection(contractorType, permits);
            sectionsContainer.appendChild(section);
        }
    });
}

function createContractorSection(contractorType, permits) {
    const section = document.createElement('div');
    section.className = 'contractor-section';
    
    const header = document.createElement('div');
    header.className = 'section-header';
    header.innerHTML = `
        <h3>
            ${contractorType}
            <span class="count">${permits.length} permits</span>
        </h3>
    `;
    
    const table = document.createElement('table');
    table.className = 'permit-table';
    table.innerHTML = `
        <thead>
            <tr>
                <th>Permit Number</th>
                <th>Project Type</th>
                <th>Status</th>
                <th>Work Type</th>
                <th>Property Address</th>
                <th>Value</th>
                <th>Application Date</th>
            </tr>
        </thead>
        <tbody>
            ${permits.map(permit => `
                <tr>
                    <td>${permit['Permit Number']}</td>
                    <td>${permit['Permit Type']}</td>
                    <td><span class="status-badge status-${permit['Status'].toLowerCase()}">${permit['Status']}</span></td>
                    <td>${permit['Work Type']}</td>
                    <td>${permit['Property Address']}</td>
                    <td class="value-cell">${permit['Construction Value']}</td>
                    <td>${permit['Application Date']}</td>
                </tr>
            `).join('')}
        </tbody>
    `;
    
    section.appendChild(header);
    section.appendChild(table);
    return section;
}
</script>
{% endblock %}
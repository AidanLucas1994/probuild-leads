{% extends "base.html" %}

{% block content %}
<div class="dashboard">
    <nav class="dashboard-nav">
        <div class="nav-content">
            <div class="nav-title-group">
                <div class="nav-title">ProBuild Leads.AI</div>
                <div class="nav-subtitle">Smarter Leads for Smarter Builders</div>
            </div>
            <a href="{{ url_for('index') }}" class="nav-link">Find More Leads</a>
        </div>
    </nav>

    <main class="dashboard-content">
        <div class="page-header">
            <h1>Leads Dashboard</h1>
            <p class="header-description">View and filter construction project leads</p>
        </div>

        <div class="dashboard-header">
            <h2>Contractor Summary</h2>
            <div class="stats-grid" id="contractor-stats">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>

        <!-- Contractor Type Toggle Buttons -->
        <div class="contractor-toggles">
            <div class="toggle-group">
                <button class="toggle-btn active" data-type="all">All</button>
                <button class="toggle-btn" data-type="general">General</button>
                <button class="toggle-btn" data-type="general_contractor">General Contractor</button>
                <button class="toggle-btn" data-type="electrician">Electrician</button>
                <button class="toggle-btn" data-type="plumber">Plumber</button>
            </div>
        </div>

        <!-- Filter Controls -->
        <div class="filter-section">
            <h3>Filter Leads</h3>
            <div class="filter-controls">
                <div class="filter-group">
                    <label for="status">Status</label>
                    <select id="status" class="filter-select">
                        <option value="">All Statuses</option>
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
                <div class="filter-group">
                    <label for="workType">Work Type</label>
                    <select id="workType" class="filter-select">
                        <option value="">All Work Types</option>
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
                <div class="filter-group value-range">
                    <label>Construction Value Range</label>
                    <div class="range-inputs">
                        <div class="value-input-wrapper">
                            <span class="currency-symbol">$</span>
                            <input type="number" id="minValue" placeholder="Min Value" class="value-input">
                        </div>
                        <span class="range-separator">to</span>
                        <div class="value-input-wrapper">
                            <span class="currency-symbol">$</span>
                            <input type="number" id="maxValue" placeholder="Max Value" class="value-input">
                        </div>
                    </div>
                </div>
                <div class="filter-actions">
                    <button id="resetFilters" class="reset-btn">
                        <span class="btn-icon">×</span>
                        Clear Filters
                    </button>
                    <button id="applyFilters" class="apply-btn">
                        Apply Filters
                    </button>
                </div>
            </div>
            <div id="active-filters" class="active-filters"></div>
        </div>

        <!-- Add layout toggle after filter section -->
        <div class="view-controls">
            <div class="view-toggle">
                <button id="tableView" class="view-btn active">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2zm2-1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H2zm0 3h14v2H2V4zm0 4h14v2H2V8zm0 4h14v2H2v-2z"/>
                    </svg>
                    Table View
                </button>
                <button id="cardView" class="view-btn">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M4 2a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H4zm0 1h8a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1zm0 8a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-4a2 2 0 0 0-2-2H4zm0 1h8a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1v-4a1 1 0 0 1 1-1z"/>
                    </svg>
                    Card View
                </button>
            </div>
        </div>

        <div class="contractor-sections" id="contractor-sections">
            <!-- Will be populated by JavaScript -->
        </div>

        <!-- Add pagination controls -->
        <div class="pagination-controls">
            <div class="pagination-info">
                <span id="pagination-summary"></span>
            </div>
            <div class="pagination-buttons">
                <button id="prevPage" class="pagination-btn" disabled>Previous</button>
                <span id="currentPage"></span>
                <button id="nextPage" class="pagination-btn" disabled>Next</button>
            </div>
        </div>
    </main>
</div>

<!-- Modal for lead details -->
<div id="leadModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Permit Details</h2>
            <button class="close">&times;</button>
        </div>
        <div class="modal-body">
            <div id="leadDetails" class="lead-details">
                <!-- Will be populated dynamically -->
            </div>
        </div>
    </div>
</div>

<style>
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.stat-card h3 {
    margin: 0;
    color: #666;
    font-size: 0.9rem;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    margin-top: 0.5rem;
    color: #2c3e50;
}

.contractor-section {
    margin-bottom: 2rem;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    overflow: hidden;
}

.section-header {
    background: #f8f9fa;
    padding: 1rem;
    border-bottom: 1px solid #e9ecef;
}

.section-header h3 {
    margin: 0;
    color: #2c3e50;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.section-header .count {
    font-size: 0.9rem;
    color: #6c757d;
}

.permit-table {
    width: 100%;
    border-collapse: collapse;
}

.permit-table th,
.permit-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid #e9ecef;
}

.permit-table th {
    background: #f8f9fa;
    font-weight: 600;
    color: #495057;
}

.permit-table tr:hover {
    background: #f8f9fa;
}

.status-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.85rem;
}

.status-approved { background: #d4edda; color: #155724; }
.status-pending { background: #fff3cd; color: #856404; }
.status-in-review { background: #cce5ff; color: #004085; }
.status-expired { background: #f8d7da; color: #721c24; }

.value-cell {
    font-family: monospace;
    text-align: right;
}

.loading {
    text-align: center;
    padding: 2rem;
    color: #6c757d;
}

/* Enhanced Filter Styles */
.filter-section {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.filter-section h3 {
    margin: 0 0 1.5rem 0;
    color: #2c3e50;
    font-size: 1.2rem;
}

.filter-controls {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 1rem;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.filter-group label {
    font-size: 0.9rem;
    color: #495057;
    font-weight: 500;
}

.filter-select {
    width: 100%;
    padding: 0.625rem;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 0.95rem;
    color: #495057;
    background-color: white;
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23495057' d='M6 8.825L1.175 4 2.237 2.938 6 6.7l3.763-3.762L10.825 4z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    padding-right: 2.5rem;
}

.filter-select:focus {
    border-color: #80bdff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    outline: none;
}

.filter-select option {
    padding: 0.5rem;
}

.value-range .range-inputs {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.value-input-wrapper {
    position: relative;
    flex: 1;
}

.currency-symbol {
    position: absolute;
    left: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    color: #6c757d;
}

.value-input {
    width: 100%;
    padding: 0.625rem;
    padding-left: 1.75rem;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 0.95rem;
    color: #495057;
}

.value-input:focus {
    border-color: #80bdff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    outline: none;
}

.range-separator {
    color: #6c757d;
    font-weight: 500;
    padding: 0 0.5rem;
}

.filter-actions {
    display: flex;
    gap: 1rem;
    align-items: flex-end;
}

.reset-btn, .apply-btn {
    padding: 0.625rem 1.25rem;
    border: none;
    border-radius: 4px;
    font-size: 0.95rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.reset-btn {
    background-color: #f8f9fa;
    color: #6c757d;
}

.reset-btn:hover {
    background-color: #e9ecef;
    color: #495057;
}

.apply-btn {
    background-color: #007bff;
    color: white;
}

.apply-btn:hover {
    background-color: #0056b3;
}

.btn-icon {
    font-size: 1.2rem;
    line-height: 1;
}

.active-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 1rem;
    min-height: 24px;
}

.active-filter {
    background: #e7f5ff;
    padding: 0.25rem 0.75rem;
    border-radius: 16px;
    font-size: 0.85rem;
    color: #1864ab;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.active-filter .remove {
    cursor: pointer;
    color: #1864ab;
    font-weight: bold;
}

.active-filter .remove:hover {
    color: #dc3545;
}

/* Add pagination styles */
.pagination-controls {
    background: white;
    padding: 1rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-top: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.pagination-info {
    color: #6c757d;
    font-size: 0.9rem;
}

.pagination-buttons {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.pagination-btn {
    padding: 0.5rem 1rem;
    background-color: #007bff;
    border: none;
    border-radius: 4px;
    color: white;
    cursor: pointer;
    font-size: 0.95rem;
    transition: background-color 0.2s;
}

.pagination-btn:hover:not(:disabled) {
    background-color: #0056b3;
}

.pagination-btn:disabled {
    background-color: #e9ecef;
    cursor: not-allowed;
    color: #6c757d;
}

#currentPage {
    font-weight: 500;
    color: #495057;
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 1;
}

.modal-content {
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    overflow: hidden;
    position: relative;
    transform: translateY(-20px);
    transition: transform 0.3s ease;
}

.modal.show .modal-content {
    transform: translateY(0);
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    margin: 0;
    color: #2c3e50;
    font-size: 1.5rem;
}

.modal-body {
    padding: 1.5rem;
    overflow-y: auto;
    max-height: calc(90vh - 100px);
}

.close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: #6c757d;
    cursor: pointer;
    padding: 0.5rem;
    margin: -0.5rem;
    line-height: 1;
}

.close:hover {
    color: #dc3545;
}

.lead-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
}

.detail-group {
    margin-bottom: 1.5rem;
}

.detail-group h3 {
    color: #495057;
    font-size: 1.1rem;
    margin: 0 0 1rem 0;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #e9ecef;
}

.detail-item {
    margin-bottom: 1rem;
}

.detail-label {
    font-size: 0.9rem;
    color: #6c757d;
    margin-bottom: 0.25rem;
}

.detail-value {
    font-size: 1rem;
    color: #2c3e50;
}

.detail-value.empty {
    color: #adb5bd;
    font-style: italic;
}

.more-details-btn {
    padding: 0.375rem 0.75rem;
    background-color: #e9ecef;
    border: none;
    border-radius: 4px;
    color: #495057;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.more-details-btn:hover {
    background-color: #dee2e6;
    color: #212529;
}

/* Add styles for status badges in modal */
.status-badge.large {
    font-size: 1rem;
    padding: 0.375rem 1rem;
}

/* View Controls Styles */
.view-controls {
    background: white;
    padding: 1rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.view-toggle {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
}

.view-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    background: white;
    color: #495057;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.view-btn:hover {
    background: #f8f9fa;
    border-color: #ced4da;
}

.view-btn.active {
    background: #e7f5ff;
    border-color: #339af0;
    color: #1864ab;
}

/* Card View Styles */
.permits-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.permit-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    overflow: hidden;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    position: relative;
}

.permit-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.permit-card.high-priority {
    border-left: 4px solid #fd7e14;
}

.permit-card.high-value {
    border-left: 4px solid #40c057;
}

.card-header {
    padding: 1rem;
    background: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
}

.card-title {
    margin: 0;
    font-size: 1rem;
    color: #2c3e50;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.card-body {
    padding: 1rem;
}

.card-info {
    margin-bottom: 1rem;
}

.card-info-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
}

.card-info-label {
    color: #6c757d;
}

.card-info-value {
    color: #2c3e50;
    font-weight: 500;
}

.card-footer {
    padding: 1rem;
    background: #f8f9fa;
    border-top: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.priority-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
}

.priority-badge.high-priority {
    background: #fff3bf;
    color: #e67700;
}

.priority-badge.high-value {
    background: #d3f9d8;
    color: #2b8a3e;
}

/* Contractor Type Toggle Styles */
.contractor-toggles {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.toggle-group {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.toggle-btn {
    padding: 0.75rem 1.5rem;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    background: white;
    color: #495057;
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    text-transform: capitalize;
}

.toggle-btn:hover {
    background: #f8f9fa;
    border-color: #ced4da;
}

.toggle-btn.active {
    background: #e7f5ff;
    border-color: #339af0;
    color: #1864ab;
}
</style>

<script>
let currentPage = 1;
const itemsPerPage = 50;
let currentFilters = {
    contractorType: [],
    status: [],
    workType: [],
    minValue: null,
    maxValue: null
};

document.addEventListener('DOMContentLoaded', function() {
    initializeFilters();
    initializeContractorToggles();
    fetchLeadsData();

    // Initialize view toggle
    initializeViewToggle();
});

function initializeFilters() {
    // Add event listeners for filter changes (removed contractorType)
    ['status', 'workType'].forEach(filterId => {
        const select = document.getElementById(filterId);
        select.addEventListener('change', handleFilterChange);
    });

    // Add event listeners for value inputs
    document.getElementById('minValue').addEventListener('input', debounce(handleValueChange, 500));
    document.getElementById('maxValue').addEventListener('input', debounce(handleValueChange, 500));

    // Add event listeners for buttons
    document.getElementById('resetFilters').addEventListener('click', resetFilters);
    document.getElementById('applyFilters').addEventListener('click', applyFilters);
    document.getElementById('prevPage').addEventListener('click', () => changePage(-1));
    document.getElementById('nextPage').addEventListener('click', () => changePage(1));
}

function handleFilterChange(event) {
    const select = event.target;
    const filterId = select.id;
    
    // Update current filters
    const selectedValues = Array.from(select.selectedOptions).map(option => option.value);
    currentFilters[filterId] = selectedValues.filter(value => value !== '');
    
    updateActiveFilters();
}

function handleValueChange() {
    currentFilters.minValue = document.getElementById('minValue').value || null;
    currentFilters.maxValue = document.getElementById('maxValue').value || null;
    updateActiveFilters();
}

function updateActiveFilters() {
    const container = document.getElementById('active-filters');
    container.innerHTML = '';

    let hasActiveFilters = false;

    // Add filter tags for each category
    ['status', 'workType'].forEach(filterId => {
        const select = document.getElementById(filterId);
        const selectedOptions = Array.from(select.selectedOptions);
        selectedOptions.forEach(option => {
            if (option.value) {
                hasActiveFilters = true;
                addActiveFilterTag(container, filterId, option.value, option.text);
            }
        });
    });

    // Add value range filters if set
    const minValue = document.getElementById('minValue').value;
    const maxValue = document.getElementById('maxValue').value;
    if (minValue) {
        hasActiveFilters = true;
        addActiveFilterTag(container, 'minValue', minValue, `Min: $${Number(minValue).toLocaleString()}`);
    }
    if (maxValue) {
        hasActiveFilters = true;
        addActiveFilterTag(container, 'maxValue', maxValue, `Max: $${Number(maxValue).toLocaleString()}`);
    }

    // Update reset button visibility
    document.getElementById('resetFilters').style.display = hasActiveFilters ? 'flex' : 'none';
}

function addActiveFilterTag(container, type, value, text) {
    const tag = document.createElement('span');
    tag.className = 'active-filter';
    tag.innerHTML = `
        ${text}
        <span class="remove" data-type="${type}" data-value="${value}">×</span>
    `;
    tag.querySelector('.remove').addEventListener('click', () => removeFilter(type, value));
    container.appendChild(tag);
}

function removeFilter(type, value) {
    if (type === 'minValue' || type === 'maxValue') {
        document.getElementById(type).value = '';
        currentFilters[type] = null;
    } else {
        const select = document.getElementById(type);
        Array.from(select.options).forEach(option => {
            if (option.value === value) {
                option.selected = false;
            }
        });
        currentFilters[type] = Array.from(select.selectedOptions)
            .map(option => option.value)
            .filter(val => val !== '');
    }
    updateActiveFilters();
}

function applyFilters() {
    currentPage = 1;
    fetchLeadsData();
}

function resetFilters() {
    // Reset filter dropdowns
    ['status', 'workType'].forEach(filterId => {
        const select = document.getElementById(filterId);
        select.selectedIndex = 0;
    });

    // Reset value inputs
    document.getElementById('minValue').value = '';
    document.getElementById('maxValue').value = '';

    // Reset contractor type toggles - set 'All' as active
    document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector('.toggle-btn[data-type="all"]').classList.add('active');

    // Reset filter state
    currentFilters = {
        contractorType: [],
        status: [],
        workType: [],
        minValue: null,
        maxValue: null
    };

    updateActiveFilters();
    currentPage = 1;
    fetchLeadsData();
}

// Utility function for debouncing
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function fetchLeadsData() {
    const queryParams = new URLSearchParams();
    queryParams.append('page', currentPage);
    queryParams.append('limit', itemsPerPage);
    
    // Add contractor type filter
    if (currentFilters.contractorType.length > 0) {
        currentFilters.contractorType.forEach(type => {
            // Convert to lowercase for consistency
            const normalizedType = type.toLowerCase();
            queryParams.append('contractor_type[]', normalizedType);
            console.log('Adding contractor type filter:', normalizedType);
        });
    }
    
    // Add other filters
    if (currentFilters.status.length > 0) {
        currentFilters.status.forEach(status => {
            queryParams.append('status[]', status);
        });
    }
    
    if (currentFilters.workType.length > 0) {
        currentFilters.workType.forEach(type => {
            queryParams.append('work_type[]', type);
        });
    }
    
    if (currentFilters.minValue) queryParams.append('min_value', currentFilters.minValue);
    if (currentFilters.maxValue) queryParams.append('max_value', currentFilters.maxValue);

    // Log the query parameters for debugging
    console.log('Query parameters:', queryParams.toString());

    // Show loading state
    showLoading();

    fetch(`/leads?${queryParams.toString()}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // Log the response data for debugging
            console.log('Received data:', data);
            
            if (data.status === 'success') {
                // Log the categorized permits for debugging
                console.log('Categorized permits:', Object.keys(data.categorized_permits));
                lastFetchedData = data;
                updateUI(data);
            } else {
                console.error('Error in response:', data.message);
                showError(data.message || 'An error occurred while fetching data');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Failed to fetch leads data');
        })
        .finally(() => {
            hideLoading();
        });
}

function showLoading() {
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'loading';
    loadingDiv.className = 'loading';
    loadingDiv.textContent = 'Loading...';
    document.querySelector('.dashboard-content').appendChild(loadingDiv);
}

function hideLoading() {
    const loadingDiv = document.getElementById('loading');
    if (loadingDiv) {
        loadingDiv.remove();
    }
}

function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    errorDiv.textContent = message;
    document.querySelector('.dashboard-content').appendChild(errorDiv);
    setTimeout(() => errorDiv.remove(), 5000);
}

function updateUI(data) {
    // Log the data being processed
    console.log('Updating UI with data:', data);

    if (!data || !data.summary || !data.categorized_permits) {
        console.error('Invalid data structure received:', data);
        return;
    }

    // Update contractor stats
    updateContractorStats(data.summary);
    
    // Get the current view mode
    const isCardView = document.getElementById('cardView').classList.contains('active');
    
    // Update the display with the categorized permits
    updateContractorSections(data.categorized_permits, isCardView ? 'card' : 'table');
    
    // Update pagination if available
    if (data.pagination) {
        updatePagination(data.pagination);
    }
    
    // Update other UI elements
    updateValueRangePlaceholders(data);
    populateFilterOptions(data);
}

function populateFilterOptions(data) {
    // Get unique values from permits
    const statuses = new Set();
    const workTypes = new Set();

    Object.entries(data.categorized_permits).forEach(([contractorType, permits]) => {
        permits.forEach(permit => {
            statuses.add(permit['Status']);
            workTypes.add(permit['Work Type']);
        });
    });

    // Update status dropdown
    const statusSelect = document.getElementById('status');
    updateSelectOptions(statusSelect, Array.from(statuses).sort(), currentFilters.status);

    // Update work type dropdown
    const workTypeSelect = document.getElementById('workType');
    updateSelectOptions(workTypeSelect, Array.from(workTypes).sort(), currentFilters.workType);
}

function updateSelectOptions(select, options, selectedValues) {
    // Store current selection
    const currentValue = select.value;

    // Clear existing options except the first one (All option)
    while (select.options.length > 1) {
        select.remove(1);
    }

    // Add new options
    options.forEach(value => {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = value;
        if (selectedValues && selectedValues.includes(value)) {
            option.selected = true;
        }
        select.appendChild(option);
    });

    // Restore selection if it still exists in new options
    if (currentValue && options.includes(currentValue)) {
        select.value = currentValue;
    }
}

function updatePagination(pagination) {
    document.getElementById('prevPage').disabled = !pagination.has_prev;
    document.getElementById('nextPage').disabled = !pagination.has_next;
    document.getElementById('currentPage').textContent = 
        `Page ${pagination.page} of ${pagination.total_pages}`;
    document.getElementById('pagination-summary').textContent = 
        `Showing ${pagination.start_index} to ${pagination.end_index} of ${pagination.total_records} permits`;
}

function changePage(delta) {
    currentPage += delta;
    fetchLeadsData();
}

function updateValueRangePlaceholders(data) {
    const values = Object.values(data.summary.total_value_by_contractor)
        .map(value => parseFloat(value.replace(/[^0-9.-]+/g, '')));
    const minValue = Math.min(...values);
    const maxValue = Math.max(...values);
    
    document.getElementById('minValue').placeholder = `Min (${formatCurrency(minValue)})`;
    document.getElementById('maxValue').placeholder = `Max (${formatCurrency(maxValue)})`;
}

function calculateSummary(filteredPermits) {
    const summary = {
        total_permits: 0,
        contractor_distribution: {},
        total_value_by_contractor: {}
    };
    
    Object.entries(filteredPermits).forEach(([type, permits]) => {
        summary.total_permits += permits.length;
        summary.contractor_distribution[type] = permits.length;
        
        const totalValue = permits.reduce((sum, permit) => {
            return sum + parseFloat(permit['Construction Value'].replace(/[^0-9.-]+/g, ''));
        }, 0);
        
        summary.total_value_by_contractor[type] = formatCurrency(totalValue);
    });
    
    return summary;
}

function formatCurrency(value) {
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(value);
}

function updateContractorStats(summary) {
    const statsContainer = document.getElementById('contractor-stats');
    statsContainer.innerHTML = '';
    
    const totalCard = createStatCard('Total Permits', summary.total_permits);
    statsContainer.appendChild(totalCard);
    
    Object.entries(summary.contractor_distribution).forEach(([type, count]) => {
        const value = summary.total_value_by_contractor[type];
        const card = createStatCard(type, `${count} permits<br>${value}`);
        statsContainer.appendChild(card);
    });
}

function createStatCard(title, value) {
    const card = document.createElement('div');
    card.className = 'stat-card';
    card.innerHTML = `
        <h3>${title}</h3>
        <div class="stat-value">${value}</div>
    `;
    return card;
}

function updateContractorSections(categorizedPermits, view = 'table') {
    // Log the categorized permits being processed
    console.log('Updating sections with permits:', Object.keys(categorizedPermits));
    
    const sectionsContainer = document.getElementById('contractor-sections');
    sectionsContainer.innerHTML = '';
    
    Object.entries(categorizedPermits).forEach(([contractorType, permits]) => {
        console.log(`Processing ${contractorType} with ${permits.length} permits`);
        if (permits.length > 0) {
            const section = view === 'table' 
                ? createContractorSection(contractorType, permits)
                : createCardSection(contractorType, permits);
            sectionsContainer.appendChild(section);
        }
    });
}

function createContractorSection(contractorType, permits) {
    const section = document.createElement('div');
    section.className = 'contractor-section';
    
    const header = document.createElement('div');
    header.className = 'section-header';
    header.innerHTML = `
        <h3>
            ${contractorType}
            <span class="count">${permits.length} permits</span>
        </h3>
    `;
    
    const table = document.createElement('table');
    table.className = 'permit-table';
    table.innerHTML = `
        <thead>
            <tr>
                <th>Permit Number</th>
                <th>Project Type</th>
                <th>Status</th>
                <th>Work Type</th>
                <th>Property Address</th>
                <th>City</th>
                <th>Value</th>
                <th>Application Date</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            ${permits.map(permit => `
                <tr>
                    <td>${permit['Permit Number']}</td>
                    <td>${permit['Permit Type']}</td>
                    <td><span class="status-badge status-${permit['Status'].toLowerCase()}">${permit['Status']}</span></td>
                    <td>${permit['Work Type']}</td>
                    <td>${permit['Property Address']}</td>
                    <td>Kitchener, ON</td>
                    <td class="value-cell">${permit['Construction Value']}</td>
                    <td>${permit['Application Date']}</td>
                    <td>
                        <button class="more-details-btn" onclick="showPermitDetails(${JSON.stringify(permit).replace(/"/g, '&quot;')})">
                            More Details
                        </button>
                    </td>
                </tr>
            `).join('')}
        </tbody>
    `;
    
    section.appendChild(header);
    section.appendChild(table);
    return section;
}

function createCardSection(contractorType, permits) {
    const section = document.createElement('div');
    section.className = 'contractor-section';
    
    const header = document.createElement('div');
    header.className = 'section-header';
    header.innerHTML = `
        <h3>
            ${contractorType}
            <span class="count">${permits.length} permits</span>
        </h3>
    `;
    
    const grid = document.createElement('div');
    grid.className = 'permits-grid';
    
    permits.forEach(permit => {
        const card = createPermitCard(permit);
        grid.appendChild(card);
    });
    
    section.appendChild(header);
    section.appendChild(grid);
    return section;
}

function createPermitCard(permit) {
    const value = parseFloat(permit['Construction Value'].replace(/[^0-9.-]+/g, ''));
    const isHighValue = value >= 1000000; // Consider permits >= $1M as high value
    const isHighPriority = permit['Status'].toLowerCase() === 'approved'; // Consider approved permits as high priority
    
    const card = document.createElement('div');
    card.className = `permit-card ${isHighPriority ? 'high-priority' : ''} ${isHighValue ? 'high-value' : ''}`;
    
    card.innerHTML = `
        <div class="card-header">
            <h4 class="card-title">
                ${permit['Permit Number']}
                <span class="status-badge status-${permit['Status'].toLowerCase()}">${permit['Status']}</span>
            </h4>
        </div>
        <div class="card-body">
            <div class="card-info">
                <div class="card-info-item">
                    <span class="card-info-label">Project Type:</span>
                    <span class="card-info-value">${permit['Permit Type']}</span>
                </div>
                <div class="card-info-item">
                    <span class="card-info-label">Work Type:</span>
                    <span class="card-info-value">${permit['Work Type']}</span>
                </div>
                <div class="card-info-item">
                    <span class="card-info-label">Value:</span>
                    <span class="card-info-value">${permit['Construction Value']}</span>
                </div>
                <div class="card-info-item">
                    <span class="card-info-label">Address:</span>
                    <span class="card-info-value">${permit['Property Address']}</span>
                </div>
            </div>
        </div>
        <div class="card-footer">
            <div class="priority-indicators">
                ${isHighPriority ? '<span class="priority-badge high-priority">High Priority</span>' : ''}
                ${isHighValue ? '<span class="priority-badge high-value">High Value</span>' : ''}
            </div>
            <button class="more-details-btn" onclick="showPermitDetails(${JSON.stringify(permit).replace(/"/g, '&quot;')})">
                More Details
            </button>
        </div>
    `;
    
    return card;
}

// Modal functionality
function showPermitDetails(permit) {
    const modal = document.getElementById('leadModal');
    const detailsContainer = document.getElementById('leadDetails');
    
    // Format the details content
    detailsContainer.innerHTML = `
        <div class="detail-group">
            <h3>Permit Information</h3>
            <div class="detail-item">
                <div class="detail-label">Permit Number</div>
                <div class="detail-value">${permit['Permit Number']}</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Status</div>
                <div class="detail-value">
                    <span class="status-badge status-${permit['Status'].toLowerCase()} large">${permit['Status']}</span>
                </div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Application Date</div>
                <div class="detail-value">${permit['Application Date']}</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Construction Value</div>
                <div class="detail-value">${permit['Construction Value']}</div>
            </div>
        </div>

        <div class="detail-group">
            <h3>Project Details</h3>
            <div class="detail-item">
                <div class="detail-label">Project Type</div>
                <div class="detail-value">${permit['Permit Type']}</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Work Type</div>
                <div class="detail-value">${permit['Work Type']}</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Description</div>
                <div class="detail-value">${permit['Description'] || '<span class="empty">No description available</span>'}</div>
            </div>
        </div>

        <div class="detail-group">
            <h3>Location Information</h3>
            <div class="detail-item">
                <div class="detail-label">Property Address</div>
                <div class="detail-value">${permit['Property Address']}</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">City</div>
                <div class="detail-value">Kitchener, ON</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Legal Description</div>
                <div class="detail-value">${permit['Legal Description'] || '<span class="empty">Not available</span>'}</div>
            </div>
        </div>

        <div class="detail-group">
            <h3>Contact Information</h3>
            <div class="detail-item">
                <div class="detail-label">Contractor</div>
                <div class="detail-value">${permit['Contractor'] || '<span class="empty">Not specified</span>'}</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Contractor Contact</div>
                <div class="detail-value">${permit['Contractor Contact'] || '<span class="empty">No contact information</span>'}</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Owner</div>
                <div class="detail-value">${permit['Owner'] || '<span class="empty">Not specified</span>'}</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Applicant</div>
                <div class="detail-value">${permit['Applicant'] || '<span class="empty">Not specified</span>'}</div>
            </div>
        </div>
    `;
    
    // Show the modal with animation
    modal.classList.add('show');
    
    // Handle closing the modal
    const closeModal = () => {
        modal.classList.remove('show');
    };
    
    modal.querySelector('.close').addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeModal();
        }
    });
    
    // Handle escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeModal();
        }
    });
}

function initializeViewToggle() {
    const tableViewBtn = document.getElementById('tableView');
    const cardViewBtn = document.getElementById('cardView');
    
    tableViewBtn.addEventListener('click', () => {
        tableViewBtn.classList.add('active');
        cardViewBtn.classList.remove('active');
        updateContractorSections(lastFetchedData.categorized_permits, 'table');
    });
    
    cardViewBtn.addEventListener('click', () => {
        cardViewBtn.classList.add('active');
        tableViewBtn.classList.remove('active');
        updateContractorSections(lastFetchedData.categorized_permits, 'card');
    });
}

function initializeContractorToggles() {
    const toggleGroup = document.querySelector('.toggle-group');
    toggleGroup.addEventListener('click', (e) => {
        const btn = e.target.closest('.toggle-btn');
        if (!btn) return;

        // Update active state
        document.querySelectorAll('.toggle-btn').forEach(button => {
            button.classList.remove('active');
        });
        btn.classList.add('active');

        // Get the contractor type from the button
        const contractorType = btn.dataset.type;
        
        // Map the toggle button types to the actual contractor types
        const contractorTypeMap = {
            'all': '',
            'general': 'general',
            'general_contractor': 'general contractor',
            'electrician': 'electrician',
            'plumber': 'plumber'
        };

        // Update filters based on the selected toggle
        if (contractorType === 'all') {
            currentFilters.contractorType = [];
        } else {
            const mappedType = contractorTypeMap[contractorType];
            currentFilters.contractorType = [mappedType];
        }

        // Log the current state for debugging
        console.log('Selected contractor type:', contractorType);
        console.log('Mapped contractor type:', currentFilters.contractorType);
        console.log('Current filters:', currentFilters);

        // Reset to first page and fetch new data
        currentPage = 1;
        fetchLeadsData();
    });
}

let lastFetchedData = null;
</script>
{% endblock %}